#!/usr/bin/make -f
# -*- makefile -*-

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

# keep lintian happy:
build: build-arch build-indep
build-arch: build-stamp
build-indep:

build-stamp:
	./debian/remove-werror.sh
	(cd ..; mkdir -p KERNEL_OUT_ASTRO)
	@echo configuring
	make O=../KERNEL_OUT_ASTRO ARCH=arm64 k6873v1_64_defconfig
ifneq ($(DEB_HOST_ARCH), arm64)
	@echo building kernel
	make O=../KERNEL_OUT_ASTRO ARCH=arm64 CROSS_COMPILE=/usr/bin/aarch64-linux-gnu- -j8
else
	@echo building kernel
	make O=../KERNEL_OUT_ASTRO ARCH=arm64 -j8
endif
	@echo done

clean: checkdir
	(cd ..; rm -rf KERNEL_OUT_ASTRO)

binary-arch:
	-rm -rf debian/tmp
	install -p -d -o root -g root -m 755 debian/tmp
	install -p -d -o root -g root -m 755 debian/tmp/DEBIAN
	install -p -d -o root -g root -m 755 debian/tmp/usr/share/kernel
	install -p    -o root -g root -m 644 ../KERNEL_OUT_ASTRO/arch/arm64/boot/Image.gz debian/tmp/usr/share/kernel/Astro-Image.gz
	install -p    -o root -g root -m 644 ../KERNEL_OUT_ASTRO/arch/arm64/boot/dts/mediatek/mt6873.dtb debian/tmp/usr/share/kernel/
	install -p    -o root -g root -m 755 debian/postinst debian/tmp/DEBIAN/
	make O=../KERNEL_OUT_ASTRO INSTALL_MOD_PATH=$(CURDIR)/debian/tmp ARCH=arm64 modules_install
	unlink debian/tmp/lib/modules/4.14.186*/source
	unlink debian/tmp/lib/modules/4.14.186*/build
	ln -s /usr/src/linux-headers-4.14 debian/tmp/lib/modules/build
	mv debian/tmp/lib/modules/build debian/tmp/lib/modules/4.14.186*/

	dpkg-gencontrol -DArchitecture=arm64 -pastro-linux-kernel
	dpkg --build debian/tmp ..

binary-indep:
	-rm -rf debian/tmp
	install -p -d -o root -g root -m 755 debian/tmp
	install -p -d -o root -g root -m 755 debian/tmp/DEBIAN
	install -p -d -o root -g root -m 755 debian/tmp/usr/src/linux-headers-4.14
	make O=../KERNEL_OUT_ASTRO INSTALL_MODULES_HDR_PATH=$(CURDIR)/debian/tmp/usr/src/linux-headers-4.14 ARCH=arm64 modules_headers_install
	dpkg-gencontrol -pastro-linux-kernel-headers
	dpkg --build debian/tmp ..

binary:         binary-arch binary-indep

checkdir:
	@test -f debian/rules

checkroot: checkdir
	@test 0 = `id -u` || { echo "Error: not super-user"; exit 1; }

.PHONY: binary binary-arch binary-indep clean checkroot checkdir build build-arch build-indep
